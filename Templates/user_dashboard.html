<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkGuard Scanner - User Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts for Roboto -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-end gap-2 mb-3">
            <button id="themeToggle" class="btn btn-secondary">Toggle Light Mode</button>
        </div>
        <a href="/" class="btn btn-secondary mb-3">Back to Scanner</a>
        <h1 class="text-center mb-4">LinkGuard Scanner - User Dashboard</h1>
        
        <div class="card bg-dark text-white mb-4" id="historyCard">
            <div class="card-body">
                <h2 class="card-title">Scan History</h2>
                <p id="tableStatus">Showing last {{ total_entries }} entries</p>
                <div class="table-responsive">
                    <table class="table table-dark table-bordered">
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>URL</th>
                                <th>Risk Level</th>
                                <th>Risk Factors</th>
                                <th>Threat Report</th>
                                <th>Scan Type</th>
                            </tr>
                        </thead>
                        <tbody id="historyTable"></tbody>
                    </table>
                </div>
                <div id="loadingSpinner" class="spinner"></div>
            </div>
        </div>
        <div class="card bg-dark text-white" id="riskCard">
            <div class="card-body">
                <h2 class="card-title">Risk Distribution</h2>
                <canvas id="riskChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <p>© 2025 LinkGuard Scanner. All rights reserved.</p>
    </footer>

    <!-- Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
    <script>
        const history = {{ (history or []) | tojson | safe }};
        console.log("Initial history length from Jinja2:", history.length);
    
        function renderTable() {
            const historyTable = document.getElementById("historyTable");
            historyTable.innerHTML = "";
    
            if (!Array.isArray(history)) {
                historyTable.innerHTML = '<tr><td colspan="6">No scan history available.</td></tr>';
                document.getElementById("tableStatus").textContent = "No entries to show";
                return;
            }
    
            let validHistory = history.filter(entry => 
                entry && typeof entry === 'object' && 'timestamp' in entry && 'url' in entry && 'risk_category' in entry
            );
    
            validHistory.forEach(entry => {
                const row = document.createElement("tr");
                const riskClass = `risk-${entry.risk_category.toLowerCase()}`;
                let findingsHtml = "<ul>";
                for (const [check, value] of Object.entries(entry.findings || {})) {
                    findingsHtml += `<li>${check}: ${value ? "⚠️ Detected" : "✅ Safe"}</li>`;
                }
                findingsHtml += "</ul>";
    
                let threatReportButton = entry.threat_report ?
                    `<button class="btn btn-threat-report btn-sm" onclick="showThreatReport('${entry.threat_report.replace(/'/g, "\\'").replace(/\n/g, '\\n').replace(/\r/g, '\\r')}')">View Threat Report</button>` :
                    "N/A";
    
                row.innerHTML = `
                    <td>${entry.timestamp}</td>
                    <td><span class="url-truncate" title="${entry.url}">${entry.url}</span></td>
                    <td class="${riskClass}">${entry.risk_category}</td>
                    <td>${findingsHtml}</td>
                    <td>${threatReportButton}</td>
                    <td>${entry.source === "qr_scan" ? "QR Scan" : "Scan"}</td>
                `;
                historyTable.appendChild(row);
            });
    
            document.getElementById("tableStatus").textContent = `Showing ${validHistory.length} entries`;
        }
    
        // Initialize Chart.js
        const ctx = document.getElementById('riskChart').getContext('2d');
        const riskChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['High', 'Medium', 'Low'],
                datasets: [{
                    label: 'Risk Distribution',
                    data: [{{ risks.High | default(0) }}, {{ risks.Medium | default(0) }}, {{ risks.Low | default(0) }}],
                    backgroundColor: ['#FF0000', '#FFA500', '#00FF00'],
                    borderColor: '#FFFFFF',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: 'var(--text-color)'
                        }
                    },
                    title: {
                        display: true,
                        text: 'Risk Distribution of Scans',
                        color: 'var(--text-color)'
                    }
                }
            }
        });
    
        function showThreatReport(report) {
            try {
                const modalElement = document.getElementById('threatReportModal');
                if (!modalElement) {
                    throw new Error("Modal element not found in DOM");
                }
                const modal = new bootstrap.Modal(modalElement);
                const contentElement = document.getElementById('threatReportContent');
                if (!contentElement) {
                    throw new Error("Threat report content element not found in DOM");
                }
                contentElement.textContent = report;
                modal.show();
            } catch (error) {
                console.error("Error showing threat report:", error);
                alert("Error displaying threat report: " + error.message);
            }
        }
    
        // Initialize table
        renderTable();
    
        // Dark Mode Toggle
        document.getElementById('themeToggle').addEventListener('click', () => {
            const body = document.body;
            const historyCard = document.getElementById('historyCard');
            const riskCard = document.getElementById('riskCard');
            const isLightMode = body.classList.toggle('light-mode');
            localStorage.setItem('theme', isLightMode ? 'light' : 'dark');
            document.getElementById('themeToggle').textContent = isLightMode ? 'Toggle Dark Mode' : 'Toggle Light Mode';
            // Toggle text color on the cards
            if (isLightMode) {
                historyCard.classList.remove('text-white');
                historyCard.classList.add('text-dark');
                riskCard.classList.remove('text-white');
                riskCard.classList.add('text-dark');
            } else {
                historyCard.classList.remove('text-dark');
                historyCard.classList.add('text-white');
                riskCard.classList.remove('text-dark');
                riskCard.classList.add('text-white');
            }
            // Update Chart.js text colors dynamically
            riskChart.options.plugins.legend.labels.color = isLightMode ? '#333333' : '#FFFFFF';
            riskChart.options.plugins.title.color = isLightMode ? '#333333' : '#FFFFFF';
            riskChart.update();
        });

        // Apply saved theme on page load
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
            document.body.classList.add('light-mode');
            const historyCard = document.getElementById('historyCard');
            const riskCard = document.getElementById('riskCard');
            document.getElementById('themeToggle').textContent = 'Toggle Dark Mode';
            historyCard.classList.remove('text-white');
            historyCard.classList.add('text-dark');
            riskCard.classList.remove('text-white');
            riskCard.classList.add('text-dark');
            // Update Chart.js text colors on load
            riskChart.options.plugins.legend.labels.color = '#333333';
            riskChart.options.plugins.title.color = '#333333';
            riskChart.update();
        }
    </script>

    <!-- Modal for Threat Report -->
    <div class="modal fade" id="threatReportModal" tabindex="-1" aria-labelledby="threatReportModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title" id="threatReportModalLabel">Threat Report</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <pre id="threatReportContent"></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>