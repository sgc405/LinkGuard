<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkGuard Scanner - Admin Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts for Roboto -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-end gap-2 mb-3">
            <button id="themeToggle" class="btn btn-secondary">Toggle Light Mode</button>
            <!-- ✨ new logout button -->
            <a href="/logout" class="btn btn-danger">Log Out</a>
        </div>
        



        <h1 class="text-center mb-4">LinkGuard Scanner - Admin Dashboard</h1>
        
        <div class="card bg-dark text-white mb-4" id="historyCard">
            <div class="card-body">
                <h2 class="card-title">Scan History</h2>
                <div class="d-flex justify-content-start gap-2 mb-3">
                    <button class="btn btn-primary" id="toggleViewBtn" onclick="toggleView()">Show Last 10 Links</button>
                    <button class="btn btn-danger" onclick="deleteSelected()">Delete Selected</button>
                    <button class="btn btn-danger" onclick="clearHistory()">Clear All</button>
                    <a href="/export" class="btn btn-success">Export as CSV</a>
                  
                </div>
                <p id="tableStatus">Showing last 30 entries</p>
                <div class="table-responsive">
                    <table class="table table-dark table-bordered">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>
                                <th>Date & Time</th>
                                <th>URL</th>
                                <th>Risk Level</th>
                                <th>Risk Factors</th>
                                <th>Threat Report</th>
                                <th>User Feedback</th>
                                <th>Scan Type</th>
                                <th>User</th>
                            </tr>
                        </thead>
                        <tbody id="historyTable">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div id="loadingSpinner" class="spinner"></div>
            </div>
        </div>
                <!-- Risk Distribution Card -->
                <div class="card bg-dark text-white" id="riskCard">
                    <div class="card-body">
                        <h2 class="card-title">Risk Distribution</h2>
                        <canvas id="riskChart"></canvas>
                    </div>
                </div>
        
                <!-- New User Management Section -->
                <div class="card bg-dark text-white mb-4" id="userCard">
                    <div class="card-body">
                        <h2 class="card-title">User Management</h2>
                        <div class="table-responsive">
                            <table class="table table-dark table-bordered">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="userTable"></tbody>
                            </table>
                        </div>
                        <div id="userLoadingSpinner" class="spinner"></div>
                    </div>
                </div>
        
            <!-- Footer -->
            <footer>
                <p>© 2025 LinkGuard Scanner. All rights reserved.</p>
            </footer>
    </div>

    <!-- Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
    <script>
        let fullHistory  = {{ (history  or []) | tojson | safe }};
        let feedbackData = {{ (feedback or []) | tojson | safe }};
        let isShowingLast10 = false;

        console.log("Initial history length from Jinja2:", fullHistory.length);
        console.log("Initial feedback length from Jinja2:", feedbackData.length);

        async function fetchFullHistory() {
            const spinner = document.getElementById("loadingSpinner");
            spinner.style.display = "block";
            try {
                const response = await fetch("/admin/history");
                const data = await response.json();
                fullHistory = data.history || [];
                feedbackData = data.feedback || [];
                console.log("Fetched history length:", fullHistory.length);
                console.log("Fetched feedback length:", feedbackData.length);
                renderTable();
            } catch (error) {
                console.error("Error fetching history:", error);
                document.getElementById("tableStatus").textContent = "Error loading history: " + error.message;
            } finally {
                spinner.style.display = "none";
            }
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById("selectAll");
            const checkboxes = document.querySelectorAll(".row-select");
            checkboxes.forEach(checkbox => checkbox.checked = selectAll.checked);
        }

        function renderTable() {
            const historyTable = document.getElementById("historyTable");
            historyTable.innerHTML = "";

            // Ensure fullHistory is an array and filter out invalid entries
            if (!Array.isArray(fullHistory)) {
                fullHistory = [];
            }
            let validHistory = fullHistory.filter(entry => 
                entry && typeof entry === 'object' && 'timestamp' in entry && 'url' in entry && 'risk_category' in entry
            );

            // Sort by timestamp descending (most recent first)
            let sortedHistory = validHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            // Limit to last 30 or 10 entries
            let historyToShow = isShowingLast10 ? sortedHistory.slice(0, 10) : sortedHistory.slice(0, 30);

            console.log("Rendering table with length:", historyToShow.length);

            // Handle empty history
            if (historyToShow.length === 0) {
                historyTable.innerHTML = '<tr><td colspan="8">No scan history available.</td></tr>';
                document.getElementById("tableStatus").textContent = "No entries to show";
                return;
            }

            historyToShow.forEach((entry, displayIndex) => {
                const row = document.createElement("tr");
                // Find the original index in fullHistory
                const originalIndex = fullHistory.findIndex(e => e.url === entry.url && e.timestamp === entry.timestamp);
                row.setAttribute("data-index", originalIndex);

                const riskClass = `risk-${entry.risk_category.toLowerCase()}`;
                let findingsHtml = "<ul>";
                for (const [check, value] of Object.entries(entry.findings || {})) {
                    findingsHtml += `<li>${check}: ${value ? "⚠️ Detected" : "✅ Safe"}</li>`;
                }
                findingsHtml += "</ul>";

                let feedbackHtml = "";
                if (Array.isArray(feedbackData)) {
                    const feedbackEntry = feedbackData.find(f => f.url === entry.url);
                    if (feedbackEntry) {
                        feedbackHtml = feedbackEntry.user_assessment.charAt(0).toUpperCase() + feedbackEntry.user_assessment.slice(1);
                    }
                }

                let threatReportButton = entry.threat_report ?
                    `<button class="btn btn-threat-report btn-sm" onclick="showThreatReport('${entry.threat_report.replace(/'/g, "\\'").replace(/\n/g, '\\n').replace(/\r/g, '\\r')}')">View Threat Report</button>` :
                    "N/A";

                    row.innerHTML = `
                    <td><input type="checkbox" class="row-select"></td>
                    <td>${entry.timestamp}</td>
                    <td><span class="url-truncate" title="${entry.url}">${entry.url}</span></td>
                    <td class="${riskClass}">${entry.risk_category}</td>
                    <td>${findingsHtml}</td>
                    <td>${threatReportButton}</td>
                    <td>${feedbackHtml || "N/A"}</td>
                    <td>${entry.source === "qr_scan" ? "QR Scan" : "Scan"}</td>
                    <td>${entry.username || "Guest User"}</td>
                `;
                historyTable.appendChild(row);
            });

            document.getElementById("tableStatus").textContent = `Showing last ${historyToShow.length} entries`;
        }

        function toggleView() {
            isShowingLast10 = !isShowingLast10;
            document.getElementById("toggleViewBtn").textContent = isShowingLast10 ? "Show Last 30 Links" : "Show Last 10 Links";
            renderTable();
        }

        function showThreatReport(report) {
            try {
                const modalElement = document.getElementById('threatReportModal');
                if (!modalElement) {
                    throw new Error("Modal element not found in DOM");
                }
                const modal = new bootstrap.Modal(modalElement);
                const contentElement = document.getElementById('threatReportContent');
                if (!contentElement) {
                    throw new Error("Threat report content element not found in DOM");
                }
                contentElement.textContent = report;
                modal.show();
            } catch (error) {
                console.error("Error showing threat report:", error);
                alert("Error displaying threat report: " + error.message);
            }
        }

        async function deleteSelected() {
            const checkboxes = document.querySelectorAll(".row-select:checked");
            const indices = Array.from(checkboxes).map(checkbox => parseInt(checkbox.closest("tr").getAttribute("data-index")));
            if (indices.length === 0) {
                alert("Please select at least one entry to delete.");
                return;
            }

            const spinner = document.getElementById("loadingSpinner");
            spinner.style.display = "block";
            try {
                const response = await fetch("/admin/delete", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ indices: indices })
                });
                const result = await response.json();
                if (result.error) {
                    alert(result.error);
                } else {
                    alert(result.message);
                    await fetchFullHistory();
                }
            } catch (error) {
                console.error("Error deleting entries:", error);
                alert(`Error deleting entries: ${error.message}`);
            } finally {
                spinner.style.display = "none";
            }
        }

        async function clearHistory() {
            if (!confirm("Are you sure you want to clear all scan history? This action cannot be undone.")) {
                return;
            }

            const spinner = document.getElementById("loadingSpinner");
            spinner.style.display = "block";
            try {
                const response = await fetch("/admin/clear", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" }
                });
                const result = await response.json();
                if (result.error) {
                    alert(result.error);
                } else {
                    alert(result.message);
                    await fetchFullHistory();
                    isShowingLast10 = false;
                    document.getElementById("toggleViewBtn").textContent = "Show Last 10 Links";
                    document.getElementById("tableStatus").textContent = `Showing last ${fullHistory.length} entries`;
                }
            } catch (error) {
                console.error("Error clearing history:", error);
                alert(`Error clearing history: ${error.message}`);
            } finally {
                spinner.style.display = "none";
            }
        }

        //render user
        function renderUserTable() {
            const userTable = document.getElementById("userTable");
            userTable.innerHTML = "";

            const users = {{ (users or []) | tojson | safe }};
            if (!Array.isArray(users) || users.length === 0) {
                userTable.innerHTML = '<tr><td colspan="2">No users found.</td></tr>';
                return;
            }

            users.forEach(username => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${username}</td>
                    <td><button class="btn btn-danger btn-sm" onclick="deleteUser('${username}')">Delete</button></td>
                `;
                userTable.appendChild(row);
            });
        }

        async function deleteUser(username) {
            if (!confirm(`Are you sure you want to delete user ${username}? This action cannot be undone.`)) {
                return;
            }

            const spinner = document.getElementById("userLoadingSpinner");
            spinner.style.display = "block";
            try {
                const response = await fetch("/admin/delete_user", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username: username })
                });
                const result = await response.json();
                if (result.error) {
                    alert(result.error);
                } else {
                    alert(result.message);
                    // Refresh both the scan history and user list
                    await fetchFullHistory();
                    renderUserTable();
                }
            } catch (error) {
                console.error("Error deleting user:", error);
                alert(`Error deleting user: ${error.message}`);
            } finally {
                spinner.style.display = "none";
            }
        }

        // Initialize Chart.js
        const ctx = document.getElementById('riskChart').getContext('2d');
        const riskChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['High', 'Medium', 'Low'],
                datasets: [{
                    label: 'Risk Distribution',
                    data: [{{ risks.High | default(0) }}, {{ risks.Medium | default(0) }}, {{ risks.Low | default(0) }}],
                    backgroundColor: ['#FF0000', '#FFA500', '#00FF00'],
                    borderColor: '#FFFFFF',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: 'var(--text-color)' // Dynamic color for legend
                        }
                    },
                    title: {
                        display: true,
                        text: 'Risk Distribution of Scans',
                        color: 'var(--text-color)'
                    }
                }
            }
        });

        // Initialize table
        renderTable();

        // Initialize user table
        renderUserTable();

        // Dark Mode Toggle
        document.getElementById('themeToggle').addEventListener('click', () => {
            const body = document.body;
            const historyCard = document.getElementById('historyCard');
            const riskCard = document.getElementById('riskCard');
            const userCard = document.getElementById('userCard');
            const isLightMode = body.classList.toggle('light-mode');
            localStorage.setItem('theme', isLightMode ? 'light' : 'dark');
            document.getElementById('themeToggle').textContent = isLightMode ? 'Toggle Dark Mode' : 'Toggle Light Mode';
            // Toggle text color on the cards
            if (isLightMode) {
                historyCard.classList.remove('text-white');
                historyCard.classList.add('text-dark');
                riskCard.classList.remove('text-white');
                riskCard.classList.add('text-dark');
                userCard.classList.remove('text-white');
                userCard.classList.add('text-dark');
            } else {
                historyCard.classList.remove('text-dark');
                historyCard.classList.add('text-white');
                riskCard.classList.remove('text-dark');
                riskCard.classList.add('text-white');
                userCard.classList.remove('text-dark');
                userCard.classList.add('text-white');
            }
            // Update Chart.js colors and text dynamically
            const updatedColors = getChartColors();
            riskChart.data.datasets[0].backgroundColor = [updatedColors.high, updatedColors.medium, updatedColors.low];
            riskChart.options.plugins.legend.labels.color = isLightMode ? '#343A40' : '#F8F9FA';
            riskChart.options.plugins.title.color = isLightMode ? '#343A40' : '#F8F9FA';
            riskChart.update();
        });

        // Apply saved theme on page load
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
            document.body.classList.add('light-mode');
            const historyCard = document.getElementById('historyCard');
            const riskCard = document.getElementById('riskCard');
            const userCard = document.getElementById('userCard');
            document.getElementById('themeToggle').textContent = 'Toggle Dark Mode';
            historyCard.classList.remove('text-white');
            historyCard.classList.add('text-dark');
            riskCard.classList.remove('text-white');
            riskCard.classList.add('text-dark');
            userCard.classList.remove('text-white');
            userCard.classList.add('text-dark');
            const updatedColors = getChartColors();
            riskChart.data.datasets[0].backgroundColor = [updatedColors.high, updatedColors.medium, updatedColors.low];
            riskChart.options.plugins.legend.labels.color = '#343A40';
            riskChart.options.plugins.title.color = '#343A40';
            riskChart.update();
        } else {
            document.body.classList.remove('light-mode');
            const historyCard = document.getElementById('historyCard');
            const riskCard = document.getElementById('riskCard');
            const userCard = document.getElementById('userCard');
            document.getElementById('themeToggle').textContent = 'Toggle Light Mode';
            historyCard.classList.remove('text-dark');
            historyCard.classList.add('text-white');
            riskCard.classList.remove('text-dark');
            riskCard.classList.add('text-white');
            userCard.classList.remove('text-dark');
            userCard.classList.add('text-white');
            const updatedColors = getChartColors();
            riskChart.data.datasets[0].backgroundColor = [updatedColors.high, updatedColors.medium, updatedColors.low];
            riskChart.options.plugins.legend.labels.color = '#F8F9FA';
            riskChart.options.plugins.title.color = '#F8F9FA';
            riskChart.update();
        }
    </script>

    <!-- Modal for Threat Report -->
    <div class="modal fade" id="threatReportModal" tabindex="-1" aria-labelledby="threatReportModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title" id="threatReportModalLabel">Threat Report</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <pre id="threatReportContent"></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9326914f1a064542',t:'MTc0NTAwNDUzMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>